<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½æ¯›çƒå† å†›èµ›</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #00b894; --primary-dark: #00a884; --accent: #0984e3; --gold: #fdcb6e;
            --bg-gradient: linear-gradient(135deg, #81ecec 0%, #55efc4 100%);
            --card-bg: rgba(255, 255, 255, 0.95); --text-main: #2d3436;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gradient); color: var(--text-main); padding: 20px; margin: 0; padding-bottom: 80px; /* ä¸ºåº•éƒ¨æŒ‰é’®ç•™ç©º */ }
        .container { max-width: 1280px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; margin: 0 0 15px 0; color: #006266; }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        input { border: none; background: transparent; width: 100%; outline: none; text-align: center; }
        .input-group { display: flex; margin-bottom: 5px; background: #eee; padding: 5px; border-radius: 4px; }
        .input-group label { min-width: 64px; white-space: nowrap; font-weight: 600; text-align: center; }
        /* å°ç»„èµ›æ¯”èµ›è¡Œæ ·å¼ï¼šæ¯”åˆ†å±…ä¸­ï¼Œä¸¤ä¾§é˜Ÿå */
        .match-row {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 6px;
            gap: 15px;
        }
        /* é˜Ÿä¼åæ ·å¼ - ä¿æŒä¸¤ä¾§ */
        .team-name {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .team-name:first-child { text-align: right; padding-right: 10px; }
        .team-name:last-child { text-align: left; padding-left: 10px; }
        /* æ¯”åˆ†åŒºåŸŸæ ·å¼ */
        .score-container {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }
        .score-separator {
            font-weight: bold;
            color: #333;
        }
        .score-input {
            width: 40px; 
            text-align: center; 
            font-weight: bold; 
            font-size: 1.1em; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background: white;
            appearance: textfield;
            /* éšè—æ•°å­—è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ï¼ˆå¯é€‰ï¼‰ */
            -moz-appearance: textfield;
        }
        /* å¯¹äºæ”¯æŒWebKitçš„æµè§ˆå™¨ */
        .score-input::-webkit-outer-spin-button,
        .score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* æ·»åŠ ç„¦ç‚¹æ—¶çš„æ ·å¼ */
        .score-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
            outline: none;
        }
        /* è¾“å…¥æ— æ•ˆå€¼æ—¶çš„æ ·å¼ */
        .score-input:invalid {
            border-color: #ff7675;
            background-color: #ffeaea;
        }
        
        /* è¡¨æ ¼ä¸é«˜äº® */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 5px; text-align: center; border-bottom: 1px solid #ddd; }
        .rank-q { background: #e6fffa; color: #006266; font-weight: bold; }
        .rank-out { background: #ffeaea; color: #b2bec3; text-decoration: line-through; }

        /* æ·˜æ±°èµ›æ ‘çŠ¶å›¾ */
        .bracket-container { overflow-x: auto; padding: 10px 0; }
        .bracket-flex { display: flex; justify-content: space-between; min-width: 900px; }
        .round-column { display: flex; flex-direction: column; justify-content: space-around; flex: 1; padding: 0 10px; }
        .match-card { background: white; border: 1px solid #dfe6e9; border-radius: 8px; padding: 10px; margin: 10px 0; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: border-color 0.2s, background 0.2s, opacity 0.2s; }
        .round-sf .match-card { margin: 60px 0; border-color: var(--accent); border-width: 2px; }
        .round-final .match-card { border-color: var(--gold); border-width: 3px; transform: scale(1.1); }
        .team-slot { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9rem; align-items: center;}
        /* çŠ¶æ€æç¤º */
        .match-card.completed { border-left: 4px solid var(--primary); background: #f8fffe; }
        .match-card.in-progress { border-left: 4px solid var(--accent); }
        .match-card.not-started { opacity: 0.7; }
        
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width:768px){ .setup-grid{grid-template-columns: 1fr;} }

        /* --- æ‚¬æµ®åˆ·æ–°æŒ‰é’® --- */
        .fab-refresh {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--accent); color: white;
            padding: 15px 25px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4);
            cursor: pointer; font-size: 1rem; font-weight: bold; border: none;
            z-index: 1000; display: flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .fab-refresh:active { transform: scale(0.95); }
        .fab-refresh.loading { background: #b2bec3; pointer-events: none; }
        
        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .icon-spin { animation: spin 1s linear infinite; display: inline-block; }

        
        /* === è½®æ’­å›¾æ ·å¼å¼€å§‹ === */
        .slider-container {
            display: flex;
            overflow-x: auto; /* å…è®¸æ¨ªå‘æ»šåŠ¨ */
            scroll-snap-type: x mandatory; /* å¼ºåˆ¶å¯¹é½ */
            gap: 10px; /* å›¾ç‰‡é—´è· */
            padding-bottom: 10px;
            /* éšè—æ»šåŠ¨æ¡ */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE/Edge */
        }
        .slider-container::-webkit-scrollbar { display: none; /* Chrome/Safari */ }
        

        /* slider å®¹å™¨é¡¹ï¼šä¸è£åˆ‡å›¾ç‰‡ï¼Œå±…ä¸­æ˜¾ç¤ºï¼Œä½¿ç”¨èƒŒæ™¯ä½œä¸º letterbox */
        .slider-item {
            flex: 0 0 100%;
            scroll-snap-align: center;
            border-radius: 8px;
            overflow: hidden;
        
            /* ä½¿ç”¨ flex å±…ä¸­å›¾ç‰‡ï¼ˆé˜²æ­¢å›¾ç‰‡ä¸Šä¸‹å±…ä¸­å‡ºç°ç©ºç™½ï¼‰ */
            display: flex;
            align-items: center;
            justify-content: center;
        
            /* letterbox èƒŒæ™¯è‰²ï¼Œå½“å›¾ç‰‡ä¸å®¹å™¨å®½é«˜æ¯”ä¸åŒæ—¶æ˜¾ç¤ºè¯¥èƒŒæ™¯ */
            background: #f3f3f3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        
            /* ä¸å›ºå®šé«˜åº¦ï¼Œè®©å›¾ç‰‡ç”¨ max-height é™åˆ¶ï¼›ä¹Ÿå¯ä»¥æ”¹ä¸º min-height:200px ä»¥ä¿è¯æœ€å°é«˜åº¦ */
            min-height: 200px;
        }
        
        /* å›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼ˆcontainï¼‰ï¼Œä¸è£åˆ‡ã€ä¸æ‹‰ä¼¸ï¼Œä¿æŒæ¯”ä¾‹ */
        .slider-item img {
            max-width: 100%;
            max-height: 60vh;        /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢å›¾ç‰‡å¤ªé«˜ï¼›å¯æ ¹æ®éœ€æ±‚è°ƒæ•´ */
            width: auto;
            height: auto;
            object-fit: contain;     /* contain ä¿ç•™å®Œæ•´å›¾åƒï¼›è‹¥æƒ³è£åˆ‡æ”¹ä¸º cover */
            object-position: center; /* å±…ä¸­å¯¹é½å›¾ç‰‡ä¸»ä½“ */
            display: block;
        }
        
        /* å°å±å¹•ä¼˜åŒ–ï¼šå‡å°‘ max-heightï¼Œé˜²æ­¢å æ»¡è§†å£ */
        @media (max-width: 480px) {
            .slider-item { min-height: 140px; }
            .slider-item img { max-height: 40vh; }
        }

        /* è½®æ’­å§“å/å£å·è¾“å…¥åŒºæ ·å¼ */
        .slide-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.65) 80%);
            color: #fff;
            padding: 12px 14px;
            box-sizing: border-box;
        }
        .slider-item { position: relative; }
        .slide-info .info-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .slide-info .fixed-label { min-width: 48px; font-weight: 600; letter-spacing: 1px; }
        .slide-input {
            flex: 1;
            background: rgba(255,255,255,0.85);
            border-radius: 6px;
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.4);
            color: #2d3436;
            font-size: 0.95rem;
            text-align: left;
        }
        .slide-input::placeholder { color: #888; }
        @media (max-width: 768px) {
            .slide-info { padding: 10px; }
            .slide-info .info-row { flex-direction: column; align-items: flex-start; }
            .slide-info .fixed-label { min-width: auto; }
            .slide-input { width: 100%; text-align: left; }
        }

        /* === è½®æ’­å›¾æ ·å¼ç»“æŸ === */
        
    </style>
</head>
<body>

<button class="fab-refresh" onclick="manualRefresh()" id="refreshBtn">
    <span id="refreshIcon">ğŸ”„</span> <span id="refreshText">åˆ·æ–°æ•°æ®</span>
</button>

<div class="container">
    <div class="card">
        <h1>ğŸ¸ ç¾½æ¯›çƒå† å†›èµ›</h1>

       <div class="slider-container" id="slider-root"></div>
       <p style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:5px;">â† å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š â†’</p>
        
        <div style="background:#ff7675; padding:10px; border-radius:8px; color:white; margin-bottom:10px; display:none;" id="configBox">
            <h3>âš ï¸ é¦–æ¬¡é…ç½®</h3>
            <input type="text" id="supabaseUrl" placeholder="è¾“å…¥ Supabase URL" style="background:white; padding:5px; margin:5px 0; width:100%;">
            <input type="text" id="supabaseKey" placeholder="è¾“å…¥ Supabase Anon Key" style="background:white; padding:5px; margin:5px 0; width:100%;">
            <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <div class="card">
        <div class="setup-grid">
            <div id="namesA"><h3>Aç»„åå•</h3></div>
            <div id="namesB"><h3>Bç»„åå•</h3></div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ…°ï¸ Aç»„èµ›å†µ (å‰4æ™‹çº§)</h3>
        <table id="tableA"><thead><tr><th>#</th><th>é˜Ÿ</th><th>èƒœ</th><th>å‡€</th><th>åˆ†</th></tr></thead><tbody></tbody></table>
        <div id="matchesA" style="margin-top:10px;"></div>
    </div>
    
    <div class="card">
        <h3>ğŸ…±ï¸ Bç»„èµ›å†µ (å‰4æ™‹çº§)</h3>
        <table id="tableB"><thead><tr><th>#</th><th>é˜Ÿ</th><th>èƒœ</th><th>å‡€</th><th>åˆ†</th></tr></thead><tbody></tbody></table>
        <div id="matchesB" style="margin-top:10px;"></div>
    </div>

    <div class="card">
        <h2>ğŸ† æ·˜æ±°èµ› (8å¼º -> å† å†›)</h2>
        <div class="bracket-container">
            <div class="bracket-flex">
                <div class="round-column round-qf">
                    <div style="text-align:center;font-weight:bold;margin-bottom:10px;color:#aaa">1/4 å†³èµ›</div>
                    <div class="match-card" id="card-qf1"><div class="team-slot"><span id="qf1-p1">A1</span><input type="number" class="score-input" id="s-qf1-1" value="0" min="0" max="30" oninput="handleInput()"></div><div class="team-slot"><span id="qf1-p2">B4</span><input type="number" class="score-input" id="s-qf1-2" value="0" min="0" max="30" oninput="handleInput()"></div></div>
                    <div class="match-card" id="card-qf2"><div class="team-slot"><span id="qf2-p1">B2</span><input type="number" class="score-input" id="s-qf2-1" value="0" min="0" max="30" oninput="handleInput()"></div><div class="team-slot"><span id="qf2-p2">A3</span><input type="number" class="score-input" id="s-qf2-2" value="0" min="0" max="30" oninput="handleInput()"></div></div>
                    <div class="match-card" id="card-qf3"><div class="team-slot"><span id="qf3-p1">B1</span><input type="number" class="score-input" id="s-qf3-1" value="0" min="0" max="30" oninput="handleInput()"></div><div class="team-slot"><span id="qf3-p2">A4</span><input type="number" class="score-input" id="s-qf3-2" value="0" min="0" max="30" oninput="handleInput()"></div></div>
                    <div class="match-card" id="card-qf4"><div class="team-slot"><span id="qf4-p1">A2</span><input type="number" class="score-input" id="s-qf4-1" value="0" min="0" max="30" oninput="handleInput()"></div><div class="team-slot"><span id="qf4-p2">B3</span><input type="number" class="score-input" id="s-qf4-2" value="0" min="0" max="30" oninput="handleInput()"></div></div>
                </div>
                <div class="round-column round-sf">
                    <div style="text-align:center;font-weight:bold;margin-bottom:10px;color:#aaa">åŠå†³èµ›</div>
                    <div class="match-card" id="card-sf1"><div class="team-slot"><span id="sf1-p1">TBD</span><input type="number" class="score-input" id="s-sf1-1" value="0" min="0" max="30" oninput="handleInput()"></div><div class="team-slot"><span id="sf1-p2">TBD</span><input type="number" class="score-input" id="s-sf1-2" value="0" min="0" max="30" oninput="handleInput()"></div></div>
                    <div class="match-card" id="card-sf2"><div class="team-slot"><span id="sf2-p1">TBD</span><input type="number" class="score-input" id="s-sf2-1" value="0" min="0" max="30" oninput="handleInput()"></div><div class="team-slot"><span id="sf2-p2">TBD</span><input type="number" class="score-input" id="s-sf2-2" value="0" min="0" max="30" oninput="handleInput()"></div></div>
                </div>
                <div class="round-column round-final">
                    <div style="text-align:center;font-weight:bold;margin-bottom:10px;color:var(--gold)">ğŸ‘‘ å†³èµ›</div>
                    <div class="match-card" id="card-final"><div class="team-slot"><span id="final-p1">TBD</span><input type="number" class="score-input" id="s-final-1" value="0" min="0" max="30" oninput="handleInput()"></div><div class="team-slot"><span id="final-p2">TBD</span><input type="number" class="score-input" id="s-final-2" value="0" min="0" max="30" oninput="handleInput()"></div></div>
                    <div style="text-align:center;margin-top:15px;font-weight:bold;font-size:1.2rem;color:var(--primary)" id="champion-name">???</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸŸ¢ åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Supabase ä¿¡æ¯
    // ==========================================
    const SUPABASE_URL = 'https://qyhqntmubcdomzqxauhq.supabase.co'; // ä¾‹å¦‚ï¼šhttps://xxxx.supabase.co
    const SUPABASE_ANON_KEY = 'sb_publishable_6q04prRz0LnKGkZYuXjLQQ_At8W6P55'; 
    // ==========================================
    
    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆå°†åœ¨ init() å‡½æ•°ä¸­æ ¹æ®é…ç½®åˆå§‹åŒ–ï¼‰
    let supabaseClient = null;

    let teams = {};
    let lastRemoteData = null;

    const schedules = {
        'A': [['t1','t2'], ['t3','t4'], ['t1','t5'], ['t2','t3'], ['t4','t5'], ['t1','t3'], ['t2','t4'], ['t3','t5'], ['t1','t4'], ['t2','t5']],
        'B': [['t6','t7'], ['t8','t9'], ['t6','t10'], ['t7','t8'], ['t9','t10'], ['t6','t8'], ['t7','t9'], ['t8','t10'], ['t6','t9'], ['t7','t10']]
    };

    function initRealtime() {
        if (!supabaseClient) {
            console.error("Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•å¯ç”¨å®æ—¶ç›‘å¬");
            return;
        }

        supabaseClient
            .channel('schema-changes') // éšä¾¿å–ä¸ªåå­—
            .on(
                'postgres_changes',
                { event: 'UPDATE', schema: 'public', table: 'badminton_data', filter: 'id=eq.1' },
                (payload) => {
                    console.log('Realtime update received!', payload);
                    // æ”¶åˆ°æ›´æ–°é€šçŸ¥ï¼Œè‡ªåŠ¨åº”ç”¨æ•°æ®åˆ° UI
                    const remoteData = payload.new.data;
                    lastRemoteData = remoteData;
                    applyDataToUI(remoteData);
                    updateAll();
                    document.getElementById('refreshText').innerText = "å®æ—¶æ›´æ–°!";
                    setTimeout(() => { document.getElementById('refreshText').innerText = "åˆ·æ–°æ•°æ®"; }, 1000);
                }
            )
            .subscribe();
    }

    function init() {
        // 1. ã€æ–°å¢ã€‘å…ˆç”Ÿæˆ21å¼ è½®æ’­å›¾
        renderSlider();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°ä¿å­˜çš„ Supabase é…ç½®
        const localConfig = localStorage.getItem('supabase_config');
        let currentSupabaseUrl = SUPABASE_URL;
        let currentSupabaseKey = SUPABASE_ANON_KEY;
        
        if(localConfig) { 
            const c = JSON.parse(localConfig); 
            currentSupabaseUrl = c.supabaseUrl || SUPABASE_URL;
            currentSupabaseKey = c.supabaseKey || SUPABASE_ANON_KEY;
        }

        // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æ¡†
        if(!currentSupabaseUrl || !currentSupabaseKey || 
           currentSupabaseUrl === 'YOUR_SUPABASE_URL' || 
           currentSupabaseKey === 'YOUR_ANON_PUBLIC_KEY') { 
            document.getElementById('configBox').style.display = 'block'; 
            return; 
        }

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        supabaseClient = supabase.createClient(currentSupabaseUrl, currentSupabaseKey);

        createInputs();
        
        // åˆå§‹åŒ–æ—¶ï¼Œåªæ‹‰å–ä¸€æ¬¡
        manualRefresh(); 

        // åˆå§‹åŒ–å®æ—¶ç›‘å¬
        initRealtime();
    }

    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ–°å¢ã€‘è‡ªåŠ¨ç”Ÿæˆ21å¼ å›¾çš„å‡½æ•° ğŸ‘‡ğŸ‘‡ğŸ‘‡
    function renderSlider() {
        const container = document.getElementById('slider-root');
        let html = '';
        
        // ğŸ”„ è¿™é‡Œçš„ 21 ä»£è¡¨ä½ æœ‰21å¼ å›¾
        // å¦‚æœä»¥åå˜æˆ30å¼ ï¼ŒæŠŠ 21 æ”¹æˆ 30 å°±è¡Œäº†
        for(let i=1; i<=26; i++) {
            html += `
            <div class="slider-item">
                <img src="${i}.jpg" alt="é€‰æ‰‹${i}" loading="lazy">
                <div class="slide-info">
                    <div class="info-row">
                        <span class="fixed-label">å§“åï¼š</span>
                        <input type="text" id="slide-name-${i}" class="slide-input" placeholder="è¾“å…¥å§“å" oninput="handleInput()">
                    </div>
                    <div class="info-row">
                        <span class="fixed-label">å£å·ï¼š</span>
                        <input type="text" id="slide-slogan-${i}" class="slide-input" placeholder="è¾“å…¥å£å·" oninput="handleInput()">
                    </div>
                </div>
            </div>`;
        }
        container.innerHTML = html;
    }
    // ğŸ‘†ğŸ‘†ğŸ‘† æ–°å¢ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘†

    function saveConfig() {
        const url = document.getElementById('supabaseUrl').value;
        const key = document.getElementById('supabaseKey').value;
        if(url && key) { 
            localStorage.setItem('supabase_config', JSON.stringify({supabaseUrl: url, supabaseKey: key})); 
            location.reload(); 
        }
    }

    function createInputs() {
        let htmlA='', htmlB='';
        const groupLabels = ['ç¬¬ä¸€ç»„','ç¬¬äºŒç»„','ç¬¬ä¸‰ç»„','ç¬¬å››ç»„','ç¬¬äº”ç»„','ç¬¬ä¸€ç»„','ç¬¬äºŒç»„','ç¬¬ä¸‰ç»„','ç¬¬å››ç»„','ç¬¬äº”ç»„'];
        for(let i=1; i<=5; i++) htmlA += `<div class="input-group"><label>${groupLabels[i-1]}</label><input id="t${i}" value="é˜Ÿä¼${i}" oninput="handleInput()"></div>`;
        for(let i=6; i<=10; i++) htmlB += `<div class="input-group"><label>${groupLabels[i-1]}</label><input id="t${i}" value="é˜Ÿä¼${i}" oninput="handleInput()"></div>`;
        document.getElementById('namesA').innerHTML += htmlA;
        document.getElementById('namesB').innerHTML += htmlB;

        ['A', 'B'].forEach(group => {
            const container = document.getElementById('matches'+group);
            schedules[group].forEach((m, idx) => {
                const d = document.createElement('div');
                d.className = 'match-row';
                d.innerHTML = `
                    <span class="team-name" id="name-${group}-${idx}-1">T</span>
                    <div class="score-container">
                        <input type="number" class="score-input" id="s-${group}-${idx}-1" value="0" min="0" max="30" oninput="handleInput()">
                        <span class="score-separator">:</span>
                        <input type="number" class="score-input" id="s-${group}-${idx}-2" value="0" min="0" max="30" oninput="handleInput()">
                    </div>
                    <span class="team-name" id="name-${group}-${idx}-2">T</span>
                `;
                container.appendChild(d);
            });
        });
    }

    // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šæ‰‹åŠ¨åˆ·æ–° ---
    async function manualRefresh() {
        const btn = document.getElementById('refreshBtn');
        const icon = document.getElementById('refreshIcon');
        const text = document.getElementById('refreshText');
        
        btn.classList.add('loading');
        icon.classList.add('icon-spin');
        text.innerText = "è·å–ä¸­...";

        try {
            if (!supabaseClient) {
                text.innerText = "æœªé…ç½® Supabase";
                return;
            }

            // ğŸš€ ä½¿ç”¨ Supabase æŸ¥è¯¢ï¼Œä» badminton_data è¡¨ä¸­é€‰æ‹© data åˆ—ï¼Œid = 1
            const { data, error } = await supabaseClient
                .from('badminton_data') 
                .select('data')
                .eq('id', 1) // æˆ‘ä»¬åªå– id ä¸º 1 çš„é‚£ä¸€è¡Œ
                .single(); // åªè¿”å›ä¸€ä¸ªå¯¹è±¡

            if (error) throw error;
            
            // å¼ºåˆ¶æ›´æ–°UI
            const remoteData = data.data; // æ³¨æ„ï¼šå–åˆ°çš„æ˜¯ data å­—æ®µé‡Œçš„å†…å®¹
            lastRemoteData = remoteData;
            applyDataToUI(remoteData);
            updateAll();
            text.innerText = "åˆ·æ–°æˆåŠŸ";
            setTimeout(() => { text.innerText = "åˆ·æ–°æ•°æ®"; }, 1000);
            
        } catch(e) { 
            console.error("Supabase è¯»å–å¤±è´¥:", e); 
            text.innerText = "åˆ·æ–°å¤±è´¥";
        } finally {
            btn.classList.remove('loading');
            icon.classList.remove('icon-spin');
        }
    }

    async function pushData() {
        if (!supabaseClient) {
            console.error("Supabase æœªé…ç½®");
            return;
        }

        const uiData = collectDataFromUI();
        try {
            // ğŸš€ ä½¿ç”¨ Supabase æ›´æ–°ï¼Œæ›´æ–° id = 1 çš„é‚£ä¸€è¡Œ
            const { error } = await supabaseClient
                .from('badminton_data')
                .update({ data: uiData }) // å°†æ”¶é›†åˆ°çš„æ•°æ®å¯¹è±¡å†™å…¥åˆ° data å­—æ®µ
                .eq('id', 1); // ç¡®ä¿åªæ›´æ–° id ä¸º 1 çš„è¡Œ
                
            if (error) throw error;
            lastRemoteData = uiData;
            console.log("Supabase è‡ªåŠ¨ä¿å­˜æˆåŠŸ");
        } catch(e) { 
            console.error("Supabase è‡ªåŠ¨ä¿å­˜å¤±è´¥", e); 
        }
    }

    function collectDataFromUI() {
        const data = { names: {}, scores: {}, slides: {} };
        // åˆ†ç»„é˜Ÿä¼åç§°
        for(let i=1; i<=12; i++) { const el = document.getElementById('t'+i); if(el) data.names['t'+i] = el.value; }
        // è½®æ’­å§“åå’Œå£å·
        for(let i=1; i<=26; i++) {
            const nameEl = document.getElementById(`slide-name-${i}`);
            const sloganEl = document.getElementById(`slide-slogan-${i}`);
            if(nameEl || sloganEl) {
                data.slides['slide-'+i] = {
                    name: nameEl ? nameEl.value : '',
                    slogan: sloganEl ? sloganEl.value : ''
                };
            }
        }
        // æ¯”åˆ†
        document.querySelectorAll('.score-input').forEach(el => { if(el.value) data.scores[el.id] = el.value; });
        return data;
    }

    function applyDataToUI(data) {
        if(!data) return;
        if(data.names) for(let k in data.names) { const el = document.getElementById(k); if(el) el.value = data.names[k]; }
        if(data.scores) {
            // åªå›å¡«æœ‰æ•°æ®çš„è¾“å…¥æ¡†ï¼Œæœªä¸Šä¼ çš„æ•°æ®ä¿ç•™é»˜è®¤å€¼0
            for(let k in data.scores) { const el = document.getElementById(k); if(el) el.value = data.scores[k]; }
        }
        // å›å¡«è½®æ’­å§“å/å£å·
        if(data.slides) {
            for(let i=1; i<=26; i++) {
                const info = data.slides['slide-'+i];
                if(!info) continue;
                const nameEl = document.getElementById(`slide-name-${i}`);
                const sloganEl = document.getElementById(`slide-slogan-${i}`);
                if(nameEl) nameEl.value = info.name || '';
                if(sloganEl) sloganEl.value = info.slogan || '';
            }
        }
    }

    let debounceTimer;
    function handleInput() {
        // éªŒè¯æ‰€æœ‰åˆ†æ•°è¾“å…¥æ¡†ï¼Œé™åˆ¶åœ¨ 0-30
        document.querySelectorAll('.score-input').forEach(input => {
            const value = parseInt(input.value) || 0;
            if(value < 0) input.value = 0;
            if(value > 30) input.value = 30;
        });

        updateAll(); // ç«‹å³æœ¬åœ°è®¡ç®—
        clearTimeout(debounceTimer);
        // è¾“å…¥åœæ­¢2ç§’åè‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯
        debounceTimer = setTimeout(() => { pushData(); }, 2000);
    }

    function updateAll() {
        for(let i=1; i<=10; i++) {
            const nameVal = document.getElementById('t'+i).value;
            teams['t'+i] = { id: 't'+i, name: nameVal || 'é˜Ÿä¼'+i, wins:0, net:0, score:0 };
        }

        ['A', 'B'].forEach(group => {
            schedules[group].forEach((m, idx) => {
                const s1El = document.getElementById(`s-${group}-${idx}-1`);
                const s2El = document.getElementById(`s-${group}-${idx}-2`);
                document.getElementById(`name-${group}-${idx}-1`).innerText = teams[m[0]].name;
                document.getElementById(`name-${group}-${idx}-2`).innerText = teams[m[1]].name;

                if(s1El.value && s2El.value) {
                    const v1 = parseInt(s1El.value), v2 = parseInt(s2El.value);
                    teams[m[0]].score += v1; teams[m[1]].score += v2;
                    teams[m[0]].net += (v1-v2); teams[m[1]].net += (v2-v1);
                    // 21åˆ†åˆ¶ï¼šè‡³å°‘21åˆ†ä¸”é¢†å…ˆ2åˆ†æ‰ç®—èƒœ
                    if(v1 >= 21 && v1 > v2 && (v1 - v2 >= 2)) teams[m[0]].wins++;
                    else if(v2 >= 21 && v2 > v1 && (v2 - v1 >= 2)) teams[m[1]].wins++;
                }
            });
            updateTable(group);
        });
    }

    function updateTable(group) {
        const list = (group==='A' ? [1,2,3,4,5] : [6,7,8,9,10]).map(i=>teams['t'+i]);
        list.sort((a,b) => b.wins - a.wins || b.net - a.net || b.score - a.score);
        
        const tbody = document.querySelector(`#table${group} tbody`);
        tbody.innerHTML = '';
        list.forEach((t, i) => {
            const cls = i<4 ? 'rank-q' : 'rank-out';
            const rankLabel = `${group}${i+1}`; // Aç»„æ˜¾ç¤ºA1ã€A2ï¼ŒBç»„æ˜¾ç¤ºB1ã€B2
            tbody.innerHTML += `<tr class="${cls}"><td>${rankLabel}</td><td>${t.name}</td><td>${t.wins}</td><td>${t.net}</td><td>${t.score}</td></tr>`;
        });

        if(group === 'A') {
            fillName('qf1-p1', list[0]); fillName('qf4-p1', list[1]); fillName('qf2-p2', list[2]); fillName('qf3-p2', list[3]);
        } else {
            fillName('qf3-p1', list[0]); fillName('qf2-p1', list[1]); fillName('qf4-p2', list[2]); fillName('qf1-p2', list[3]);
        }
        updateBracket();
    }

    function fillName(id, team) {
        const el = document.getElementById(id);
        if(!el || !team) return;
        const slot = getTeamRankLabel(team);
        el.innerText = slot ? `${slot} ${team.name}` : team.name;
    }

    // æ ¹æ®å½“å‰ç§¯åˆ†æ¦œæ’åè¿”å›æ ‡ç­¾ï¼ˆA1/A2...æˆ–B1/B2...ï¼‰
    function getTeamRankLabel(team) {
        if(!team || !team.id) return '';
        const num = parseInt(team.id.replace('t',''), 10);
        if(isNaN(num)) return '';
        const group = num <= 5 ? 'A' : 'B';

        // å–å‡ºè¯¥ç»„å…¨éƒ¨é˜Ÿä¼å¹¶æŒ‰è§„åˆ™æ’åº
        const groupTeams = (group === 'A'
            ? ['t1','t2','t3','t4','t5']
            : ['t6','t7','t8','t9','t10']
        ).map(id => teams[id]);

        groupTeams.sort((a,b) => b.wins - a.wins || b.net - a.net || b.score - a.score);

        const rankIndex = groupTeams.findIndex(t => t.id === team.id);
        return rankIndex !== -1 ? `${group}${rankIndex+1}` : '';
    }

    function determineWinner(score1, score2) {
        if (score1 >= 21 && score1 > score2 && (score1 - score2 >= 2)) return 'p1';
        if (score2 >= 21 && score2 > score1 && (score2 - score1 >= 2)) return 'p2';
        return '';
    }

    function updateMatchStatus(matchId, score1, score2) {
        const matchCard = document.getElementById(matchId);
        if(!matchCard) return;
        const winner = determineWinner(score1, score2);
        matchCard.classList.remove('completed', 'in-progress', 'not-started');
        if (winner) {
            matchCard.classList.add('completed');
        } else if (score1 > 0 || score2 > 0) {
            matchCard.classList.add('in-progress');
        } else {
            matchCard.classList.add('not-started');
        }
    }

    function updateBracket() {
        const advance = (curr, next) => {
            const p1 = document.getElementById(curr+'-p1').innerText;
            const p2 = document.getElementById(curr+'-p2').innerText;
            const s1 = parseInt(document.getElementById('s-'+curr+'-1').value) || 0;
            const s2 = parseInt(document.getElementById('s-'+curr+'-2').value) || 0;
            const target = document.getElementById(next);
            
            // 21åˆ†åˆ¶ï¼šè‡³å°‘21åˆ†ä¸”é¢†å…ˆ2åˆ†æ‰ç®—èƒœ
            let winner = "";
            if (s1 >= 21 && s1 > s2 && (s1 - s2 >= 2)) winner = p1;
            else if (s2 >= 21 && s2 > s1 && (s2 - s1 >= 2)) winner = p2;

            target.innerText = winner || "TBD";
            updateMatchStatus(`card-${curr}`, s1, s2);
        };
        advance('qf1', 'sf1-p1'); advance('qf2', 'sf1-p2'); advance('qf3', 'sf2-p1'); advance('qf4', 'sf2-p2');
        advance('sf1', 'final-p1'); advance('sf2', 'final-p2');
        
        const f1 = document.getElementById('final-p1').innerText;
        const f2 = document.getElementById('final-p2').innerText;
        const fs1 = parseInt(document.getElementById('s-final-1').value) || 0;
        const fs2 = parseInt(document.getElementById('s-final-2').value) || 0;

        let champion = "???";
        if (fs1 >= 21 && fs1 > fs2 && (fs1 - fs2 >= 2)) champion = f1;
        else if (fs2 >= 21 && fs2 > fs1 && (fs2 - fs1 >= 2)) champion = f2;

        document.getElementById('champion-name').innerText = champion === "???" ? "???" : "ğŸ¥‡ " + champion;
        updateMatchStatus('card-final', fs1, fs2);
    }

    window.onload = init;
</script>
</body>
</html>






