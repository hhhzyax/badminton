<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½æ¯›çƒå† å†›èµ› (æ‰‹åŠ¨åˆ·æ–°ç‰ˆ)</title>
    <style>
        :root {
            --primary: #00b894; --primary-dark: #00a884; --accent: #0984e3; --gold: #fdcb6e;
            --bg-gradient: linear-gradient(135deg, #81ecec 0%, #55efc4 100%);
            --card-bg: rgba(255, 255, 255, 0.95); --text-main: #2d3436;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gradient); color: var(--text-main); padding: 20px; margin: 0; padding-bottom: 80px; /* ä¸ºåº•éƒ¨æŒ‰é’®ç•™ç©º */ }
        .container { max-width: 1280px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; margin: 0 0 15px 0; color: #006266; }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        input { border: none; background: transparent; width: 100%; outline: none; text-align: center; }
        .input-group { display: flex; margin-bottom: 5px; background: #eee; padding: 5px; border-radius: 4px; }
        .match-row { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 8px; margin-bottom: 5px; border-radius: 6px; }
        .score-input { width: 40px; text-align: center; font-weight: bold; font-size: 1.1em; border: 1px solid #ccc; border-radius: 4px; background: white; }
        
        /* è¡¨æ ¼ä¸é«˜äº® */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 5px; text-align: center; border-bottom: 1px solid #ddd; }
        .rank-q { background: #e6fffa; color: #006266; font-weight: bold; }
        .rank-out { background: #ffeaea; color: #b2bec3; text-decoration: line-through; }

        /* æ·˜æ±°èµ›æ ‘çŠ¶å›¾ */
        .bracket-container { overflow-x: auto; padding: 10px 0; }
        .bracket-flex { display: flex; justify-content: space-between; min-width: 900px; }
        .round-column { display: flex; flex-direction: column; justify-content: space-around; flex: 1; padding: 0 10px; }
        .match-card { background: white; border: 1px solid #dfe6e9; border-radius: 8px; padding: 10px; margin: 10px 0; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .round-sf .match-card { margin: 60px 0; border-color: var(--accent); border-width: 2px; }
        .round-final .match-card { border-color: var(--gold); border-width: 3px; transform: scale(1.1); }
        .team-slot { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9rem; align-items: center;}
        
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width:768px){ .setup-grid{grid-template-columns: 1fr;} }

        /* --- æ‚¬æµ®åˆ·æ–°æŒ‰é’® --- */
        .fab-refresh {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--accent); color: white;
            padding: 15px 25px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4);
            cursor: pointer; font-size: 1rem; font-weight: bold; border: none;
            z-index: 1000; display: flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .fab-refresh:active { transform: scale(0.95); }
        .fab-refresh.loading { background: #b2bec3; pointer-events: none; }
        
        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .icon-spin { animation: spin 1s linear infinite; display: inline-block; }
    </style>
</head>
<body>

<button class="fab-refresh" onclick="manualRefresh()" id="refreshBtn">
    <span id="refreshIcon">ğŸ”„</span> <span id="refreshText">åˆ·æ–°æ•°æ®</span>
</button>

<div class="container">
    <div class="card">
        <h1>ğŸ¸ ç¾½æ¯›çƒå† å†›èµ› (æ‰‹åŠ¨åˆ·æ–°)</h1>
        
        <div style="background:#ff7675; padding:10px; border-radius:8px; color:white; margin-bottom:10px; display:none;" id="configBox">
            <h3>âš ï¸ é¦–æ¬¡é…ç½®</h3>
            <input type="text" id="binId" placeholder="è¾“å…¥ JsonBin BIN ID" style="background:white; padding:5px; margin:5px 0;">
            <input type="text" id="apiKey" placeholder="è¾“å…¥ JsonBin API Key" style="background:white; padding:5px; margin:5px 0;">
            <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <div class="card">
        <div class="setup-grid">
            <div id="namesA"><h3>Aç»„åå•</h3></div>
            <div id="namesB"><h3>Bç»„åå•</h3></div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ…°ï¸ Aç»„èµ›å†µ (å‰4æ™‹çº§)</h3>
        <table id="tableA"><thead><tr><th>#</th><th>é˜Ÿ</th><th>èƒœ</th><th>å‡€</th><th>åˆ†</th></tr></thead><tbody></tbody></table>
        <div id="matchesA" style="margin-top:10px;"></div>
    </div>
    
    <div class="card">
        <h3>ğŸ…±ï¸ Bç»„èµ›å†µ (å‰4æ™‹çº§)</h3>
        <table id="tableB"><thead><tr><th>#</th><th>é˜Ÿ</th><th>èƒœ</th><th>å‡€</th><th>åˆ†</th></tr></thead><tbody></tbody></table>
        <div id="matchesB" style="margin-top:10px;"></div>
    </div>

    <div class="card">
        <h2>ğŸ† æ·˜æ±°èµ› (8å¼º -> å† å†›)</h2>
        <div class="bracket-container">
            <div class="bracket-flex">
                <div class="round-column round-qf">
                    <div style="text-align:center;font-weight:bold;margin-bottom:10px;color:#aaa">1/4 å†³èµ›</div>
                    <div class="match-card"><div class="team-slot"><span id="qf1-p1">A1</span><input type="number" class="score-input" id="s-qf1-1" oninput="handleInput()"></div><div class="team-slot"><span id="qf1-p2">B4</span><input type="number" class="score-input" id="s-qf1-2" oninput="handleInput()"></div></div>
                    <div class="match-card"><div class="team-slot"><span id="qf2-p1">B2</span><input type="number" class="score-input" id="s-qf2-1" oninput="handleInput()"></div><div class="team-slot"><span id="qf2-p2">A3</span><input type="number" class="score-input" id="s-qf2-2" oninput="handleInput()"></div></div>
                    <div class="match-card"><div class="team-slot"><span id="qf3-p1">B1</span><input type="number" class="score-input" id="s-qf3-1" oninput="handleInput()"></div><div class="team-slot"><span id="qf3-p2">A4</span><input type="number" class="score-input" id="s-qf3-2" oninput="handleInput()"></div></div>
                    <div class="match-card"><div class="team-slot"><span id="qf4-p1">A2</span><input type="number" class="score-input" id="s-qf4-1" oninput="handleInput()"></div><div class="team-slot"><span id="qf4-p2">B3</span><input type="number" class="score-input" id="s-qf4-2" oninput="handleInput()"></div></div>
                </div>
                <div class="round-column round-sf">
                    <div style="text-align:center;font-weight:bold;margin-bottom:10px;color:#aaa">åŠå†³èµ›</div>
                    <div class="match-card"><div class="team-slot"><span id="sf1-p1">TBD</span><input type="number" class="score-input" id="s-sf1-1" oninput="handleInput()"></div><div class="team-slot"><span id="sf1-p2">TBD</span><input type="number" class="score-input" id="s-sf1-2" oninput="handleInput()"></div></div>
                    <div class="match-card"><div class="team-slot"><span id="sf2-p1">TBD</span><input type="number" class="score-input" id="s-sf2-1" oninput="handleInput()"></div><div class="team-slot"><span id="sf2-p2">TBD</span><input type="number" class="score-input" id="s-sf2-2" oninput="handleInput()"></div></div>
                </div>
                <div class="round-column round-final">
                    <div style="text-align:center;font-weight:bold;margin-bottom:10px;color:var(--gold)">ğŸ‘‘ å†³èµ›</div>
                    <div class="match-card"><div class="team-slot"><span id="final-p1">TBD</span><input type="number" class="score-input" id="s-final-1" oninput="handleInput()"></div><div class="team-slot"><span id="final-p2">TBD</span><input type="number" class="score-input" id="s-final-2" oninput="handleInput()"></div></div>
                    <div style="text-align:center;margin-top:15px;font-weight:bold;font-size:1.2rem;color:var(--primary)" id="champion-name">???</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸ”´ åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ JsonBin ä¿¡æ¯
    // ==========================================
    let BIN_ID = '69396050ae596e708f9011c8'; 
    let API_KEY = '$2a$10$HJ5TU53qmIgDkP2Zv/o68OJ5M0Bo91u8BQt51q5hAv7kDh2On5Exq'; 
    // ==========================================

    let teams = {};
    let lastRemoteData = null;

    const schedules = {
        'A': [['t1','t2'], ['t3','t4'], ['t1','t5'], ['t2','t3'], ['t4','t5'], ['t1','t3'], ['t2','t4'], ['t3','t5'], ['t1','t4'], ['t2','t5']],
        'B': [['t6','t7'], ['t8','t9'], ['t6','t10'], ['t7','t8'], ['t9','t10'], ['t6','t8'], ['t7','t9'], ['t8','t10'], ['t6','t9'], ['t7','t10']]
    };

    function init() {
        const localConfig = localStorage.getItem('img_config');
        if(localConfig) { const c = JSON.parse(localConfig); BIN_ID = c.binId; API_KEY = c.apiKey; }

        if(!BIN_ID || !API_KEY) { document.getElementById('configBox').style.display = 'block'; return; }

        createInputs();
        
        // åˆå§‹åŒ–æ—¶ï¼Œåªæ‹‰å–ä¸€æ¬¡
        manualRefresh(); 
    }

    function saveConfig() {
        const bid = document.getElementById('binId').value;
        const key = document.getElementById('apiKey').value;
        if(bid && key) { localStorage.setItem('img_config', JSON.stringify({binId: bid, apiKey: key})); location.reload(); }
    }

    function createInputs() {
        let htmlA='', htmlB='';
        for(let i=1; i<=5; i++) htmlA += `<div class="input-group"><label>A${i}</label><input id="t${i}" value="é˜Ÿä¼${i}" oninput="handleInput()"></div>`;
        for(let i=6; i<=10; i++) htmlB += `<div class="input-group"><label>B${i-5}</label><input id="t${i}" value="é˜Ÿä¼${i}" oninput="handleInput()"></div>`;
        document.getElementById('namesA').innerHTML += htmlA;
        document.getElementById('namesB').innerHTML += htmlB;

        ['A', 'B'].forEach(group => {
            const container = document.getElementById('matches'+group);
            schedules[group].forEach((m, idx) => {
                const d = document.createElement('div');
                d.className = 'match-row';
                d.innerHTML = `
                    <span id="name-${group}-${idx}-1">T</span>
                    <div>
                        <input type="number" class="score-input" id="s-${group}-${idx}-1" oninput="handleInput()"> : 
                        <input type="number" class="score-input" id="s-${group}-${idx}-2" oninput="handleInput()">
                    </div>
                    <span id="name-${group}-${idx}-2">T</span>
                `;
                container.appendChild(d);
            });
        });
    }

    // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šæ‰‹åŠ¨åˆ·æ–° ---
    async function manualRefresh() {
        const btn = document.getElementById('refreshBtn');
        const icon = document.getElementById('refreshIcon');
        const text = document.getElementById('refreshText');
        
        // æŒ‰é’®å˜æ€
        btn.classList.add('loading');
        icon.classList.add('icon-spin');
        text.innerText = "è·å–ä¸­...";

        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
            if(res.ok) {
                const json = await res.json();
                const data = json.record;
                // å¼ºåˆ¶æ›´æ–°UI
                lastRemoteData = data;
                applyDataToUI(data);
                updateAll();
                text.innerText = "åˆ·æ–°æˆåŠŸ";
                setTimeout(() => { text.innerText = "åˆ·æ–°æ•°æ®"; }, 1000);
            } else {
                text.innerText = "åˆ·æ–°å¤±è´¥";
            }
        } catch(e) { 
            console.error(e); 
            text.innerText = "ç½‘ç»œé”™è¯¯";
        } finally {
            // æ¢å¤æŒ‰é’®
            btn.classList.remove('loading');
            icon.classList.remove('icon-spin');
        }
    }

    async function pushData() {
        // ä¸Šä¼ æ—¶ï¼Œä¸éœ€è¦æ—‹è½¬æŒ‰é’®ï¼Œé™é»˜ä¸Šä¼ å³å¯ï¼Œæˆ–è€…å¯ä»¥åœ¨å³ä¸Šè§’ç»™ä¸ªå°æç¤ºï¼Œè¿™é‡Œä¿æŒç®€å•
        const data = collectDataFromUI();
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify(data)
            });
            lastRemoteData = data;
        } catch(e) { console.error("Auto save failed", e); }
    }

    function collectDataFromUI() {
        const data = { names: {}, scores: {} };
        for(let i=1; i<=10; i++) { const el = document.getElementById('t'+i); if(el) data.names['t'+i] = el.value; }
        document.querySelectorAll('.score-input').forEach(el => { if(el.value) data.scores[el.id] = el.value; });
        return data;
    }

    function applyDataToUI(data) {
        if(!data) return;
        if(data.names) for(let k in data.names) { const el = document.getElementById(k); if(el) el.value = data.names[k]; }
        if(data.scores) {
            document.querySelectorAll('.score-input').forEach(el => el.value = ''); 
            for(let k in data.scores) { const el = document.getElementById(k); if(el) el.value = data.scores[k]; }
        }
    }

    let debounceTimer;
    function handleInput() {
        updateAll(); // ç«‹å³æœ¬åœ°è®¡ç®—
        clearTimeout(debounceTimer);
        // è¾“å…¥åœæ­¢1ç§’åè‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯
        debounceTimer = setTimeout(() => { pushData(); }, 1000);
    }

    function updateAll() {
        for(let i=1; i<=10; i++) {
            const nameVal = document.getElementById('t'+i).value;
            teams['t'+i] = { id: 't'+i, name: nameVal || 'é˜Ÿä¼'+i, wins:0, net:0, score:0 };
        }

        ['A', 'B'].forEach(group => {
            schedules[group].forEach((m, idx) => {
                const s1El = document.getElementById(`s-${group}-${idx}-1`);
                const s2El = document.getElementById(`s-${group}-${idx}-2`);
                document.getElementById(`name-${group}-${idx}-1`).innerText = teams[m[0]].name;
                document.getElementById(`name-${group}-${idx}-2`).innerText = teams[m[1]].name;

                if(s1El.value && s2El.value) {
                    const v1 = parseInt(s1El.value), v2 = parseInt(s2El.value);
                    teams[m[0]].score += v1; teams[m[1]].score += v2;
                    teams[m[0]].net += (v1-v2); teams[m[1]].net += (v2-v1);
                    if(v1>v2) teams[m[0]].wins++; else if(v2>v1) teams[m[1]].wins++;
                }
            });
            updateTable(group);
        });
    }

    function updateTable(group) {
        const list = (group==='A' ? [1,2,3,4,5] : [6,7,8,9,10]).map(i=>teams['t'+i]);
        list.sort((a,b) => b.wins - a.wins || b.net - a.net || b.score - a.score);
        
        const tbody = document.querySelector(`#table${group} tbody`);
        tbody.innerHTML = '';
        list.forEach((t, i) => {
            const cls = i<4 ? 'rank-q' : 'rank-out';
            tbody.innerHTML += `<tr class="${cls}"><td>${i+1}</td><td>${t.name}</td><td>${t.wins}</td><td>${t.net}</td><td>${t.score}</td></tr>`;
        });

        if(group === 'A') {
            fillName('qf1-p1', list[0]); fillName('qf4-p1', list[1]); fillName('qf2-p2', list[2]); fillName('qf3-p2', list[3]);
        } else {
            fillName('qf3-p1', list[0]); fillName('qf2-p1', list[1]); fillName('qf4-p2', list[2]); fillName('qf1-p2', list[3]);
        }
        updateBracket();
    }

    function fillName(id, team) { if(document.getElementById(id)) document.getElementById(id).innerText = team.name; }

    function updateBracket() {
        const advance = (curr, next) => {
            const p1 = document.getElementById(curr+'-p1').innerText;
            const p2 = document.getElementById(curr+'-p2').innerText;
            const s1 = document.getElementById('s-'+curr+'-1').value;
            const s2 = document.getElementById('s-'+curr+'-2').value;
            const target = document.getElementById(next);
            if(s1 && s2) target.innerText = parseInt(s1)>parseInt(s2) ? p1 : p2;
            else target.innerText = "TBD";
        };
        advance('qf1', 'sf1-p1'); advance('qf2', 'sf1-p2'); advance('qf3', 'sf2-p1'); advance('qf4', 'sf2-p2');
        advance('sf1', 'final-p1'); advance('sf2', 'final-p2');
        
        const f1 = document.getElementById('final-p1').innerText;
        const f2 = document.getElementById('final-p2').innerText;
        const fs1 = document.getElementById('s-final-1').value;
        const fs2 = document.getElementById('s-final-2').value;
        if(fs1 && fs2) document.getElementById('champion-name').innerText = "ğŸ¥‡ " + (parseInt(fs1)>parseInt(fs2)?f1:f2);
        else document.getElementById('champion-name').innerText = "???";
    }

    window.onload = init;
</script>
</body>
</html>
